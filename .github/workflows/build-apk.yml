name: Build APK (Latest)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      run: |
        echo "Android SDK setup handled by GitHub runner"
        
    - name: Grant execute permission
      run: |
        cd CloudCounter
        chmod +x gradlew
        ls -la gradlew
        
    - name: Build with Gradle
      run: |
        cd CloudCounter
        echo "Building ${{ github.event.inputs.build_type }} APK..."
        
        # Show Gradle version and project info for debugging
        ./gradlew --version
        ./gradlew projects
        
        # Clean first
        ./gradlew clean
        
        # Build based on type with detailed output
        if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
          echo "Building debug APK..."
          ./gradlew assembleDebug --stacktrace --info
        else
          echo "Building release APK..."
          ./gradlew assembleRelease --stacktrace --info
        fi
        
        # Show build results
        echo "Build completed. Checking output directories..."
        ls -la app/build/outputs/ 2>/dev/null || echo "No build outputs directory"
        
    - name: List APK files
      run: |
        echo "Looking for APK files..."
        find CloudCounter -type f -name "*.apk" -ls
        echo "Checking specific build output directories:"
        ls -la CloudCounter/app/build/outputs/apk/ 2>/dev/null || echo "apk directory not found"
        ls -la CloudCounter/app/build/outputs/apk/*/ 2>/dev/null || echo "subdirectories not found"
        
    - name: Store APK
      uses: actions/upload-artifact@v4.3.3
      with:
        name: cloudcounter-${{ github.event.inputs.build_type }}-${{ github.run_number }}
        path: CloudCounter/app/build/outputs/apk/**/*.apk
        retention-days: 5
        if-no-files-found: error