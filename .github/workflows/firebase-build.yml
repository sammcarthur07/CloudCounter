name: Firebase Cloud Build & Distribution

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      distribution_notes:
        description: 'Release Notes'
        required: false
        default: 'Cloud build from mobile workflow'

jobs:
  build-and-distribute:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: |
        cd CloudCounter
        chmod +x gradlew
        
    - name: Check project structure
      run: |
        ls -la
        ls -la CloudCounter/
        ls -la CloudCounter/app/
        
    - name: Setup Release Keystore (for release builds)
      if: github.event.inputs.build_type == 'release'
      env:
        ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        mkdir -p CloudCounter/keystore
        echo $ENCODED_KEYSTORE | base64 -d > CloudCounter/keystore/release.jks
        
    - name: Build APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd CloudCounter
        echo "üßπ Cleaning project..."
        ./gradlew clean
        
        echo "üî® Building APK..."
        if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
          echo "Building DEBUG APK..."
          ./gradlew assembleDebug --stacktrace || { echo "‚ùå Gradle build failed!"; exit 1; }
        else
          echo "Building RELEASE APK with signing..."
          if [ ! -f "keystore/release.jks" ]; then
            echo "‚ùå Keystore file not found!"
            ls -la keystore/ || echo "Keystore directory not found"
            exit 1
          fi
          echo "‚úÖ Keystore found, building signed APK..."
          echo "Debug: Using keystore at $(pwd)/keystore/release.jks"
          echo "Debug: KEYSTORE_PASSWORD is ${KEYSTORE_PASSWORD:+set}"
          echo "Debug: KEY_ALIAS is ${KEY_ALIAS:+set}"
          echo "Debug: KEY_PASSWORD is ${KEY_PASSWORD:+set}"
          
          # Use absolute path for keystore
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/keystore/release.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD" \
            --stacktrace || { echo "‚ùå Gradle build failed!"; exit 1; }
        fi
        
        # Check if build actually succeeded
        if [ $? -ne 0 ]; then
          echo "‚ùå Build failed!"
          exit 1
        fi
        
        echo "üì¶ Build completed, checking outputs..."
        find app/build/outputs -name "*.apk" -type f -exec ls -la {} \; || echo "No APK files found in outputs"
        
    - name: List built APKs
      run: |
        find CloudCounter -name "*.apk" -type f
        
    - name: Verify APK signature and SHA-1
      run: |
        cd CloudCounter
        if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
        else
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
        fi
        
        if [ -f "$APK_PATH" ]; then
          echo "‚úÖ APK found at: $APK_PATH"
          echo "üìã APK SHA-1 fingerprint:"
          unzip -p "$APK_PATH" META-INF/CERT.RSA | keytool -printcert | grep SHA1 || echo "Could not extract SHA-1"
        else
          echo "‚ùå APK not found at expected path: $APK_PATH"
          find . -name "*.apk" -type f
        fi
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4.3.3
      with:
        name: app-${{ github.event.inputs.build_type }}
        path: |
          CloudCounter/app/build/outputs/apk/**/*.apk
        if-no-files-found: warn
          
    - name: Upload APK to Firebase App Distribution (using gradle)
      run: |
        cd CloudCounter
        if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
          ./gradlew appDistributionUploadDebug --stacktrace
        else
          ./gradlew appDistributionUploadRelease --stacktrace
        fi
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      continue-on-error: true
      
    - name: Alternative Firebase Distribution
      if: failure()
      run: |
        cd CloudCounter
        
        # Install Firebase CLI
        npm install -g firebase-tools
        
        # Find the APK - check multiple possible locations
        echo "üîç Looking for APK files..."
        find . -name "*.apk" -type f -exec ls -la {} \;
        
        APK_PATH=""
        if [ "${{ github.event.inputs.build_type }}" == "debug" ]; then
          # Check for debug APK in various locations
          for path in \
            "app/build/outputs/apk/debug/app-debug.apk" \
            "app/build/outputs/apk/debug/CloudCounter-debug.apk" \
            "app/build/outputs/apk/app-debug.apk"; do
            echo "Checking: $path"
            if [ -f "$path" ]; then
              APK_PATH="$path"
              echo "‚úÖ Found APK at: $path"
              break
            fi
          done
        else
          # Check for release APK in various locations  
          for path in \
            "app/build/outputs/apk/release/app-release.apk" \
            "app/build/outputs/apk/release/CloudCounter-release.apk" \
            "app/build/outputs/apk/app-release.apk"; do
            echo "Checking: $path"
            if [ -f "$path" ]; then
              APK_PATH="$path"
              echo "‚úÖ Found APK at: $path"
              break
            fi
          done
        fi
        
        # If no APK found in expected locations, try to find any APK
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå No APK found in expected locations, searching..."
          APK_PATH=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_PATH" ]; then
            echo "üì¶ Found APK at: $APK_PATH"
          fi
        fi
        
        # List all APK files for debugging
        echo "All APK files found:"
        find . -name "*.apk" -type f
        
        # Check if APK exists
        if [ -f "$APK_PATH" ]; then
          echo "Found APK at: $APK_PATH"
          ls -la "$APK_PATH"
          
          # Try distributing with token
          if [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            firebase appdistribution:distribute "$APK_PATH" \
              --app 1:778271181918:android:2225b29f4fe7cea4d338cf \
              --release-notes "${{ github.event.inputs.distribution_notes }}" \
              --testers "mcarthur.sp@gmail.com" \
              --token "${{ secrets.FIREBASE_TOKEN }}"
          else
            echo "FIREBASE_TOKEN not set, skipping Firebase distribution"
          fi
        else
          echo "APK not found at: $APK_PATH"
          exit 1
        fi